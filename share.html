<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0" />
  <title>Share Screen (Offer)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: Arial, sans-serif; background:#0c0c0c; color:#eee; padding:16px; }
    h1 { font-size:24px; margin-bottom:12px; }
    button, textarea, input { font-size:18px; border-radius:12px; border:2px solid #444; padding:14px; width:100%; box-sizing:border-box; background:#1b1b1b; color:#eee; }
    button { cursor:pointer; margin:8px 0; background:#2d6cdf; border:none; }
    button.secondary { background:#444; }
    .row { margin:12px 0; }
    .label { margin:6px 0; font-weight:bold; }
    video { width:100%; max-height:240px; background:#111; border:1px solid #333; border-radius:12px; object-fit:contain; }
  </style>
</head>
<body>
  <h1>Share Screen (You)</h1>

  <div class="row">
    <button id="startBtn">1) Start screen + mic</button>
  </div>

  <video id="preview" autoplay muted playsinline></video>

  <div class="row">
    <div class="label">2) Send this link to your friend:</div>
    <textarea id="viewerLink" rows="3" readonly></textarea>
    <button id="copyLinkBtn" class="secondary">Copy viewer link</button>
  </div>

  <div class="row">
    <div class="label">3) Paste their answer and connect:</div>
    <textarea id="answerBox" rows="3" placeholder="Paste answer JSON here"></textarea>
    <button id="applyAnswerBtn">Apply answer</button>
  </div>

  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    const startBtn = document.getElementById('startBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const applyAnswerBtn = document.getElementById('applyAnswerBtn');
    const viewerLink = document.getElementById('viewerLink');
    const answerBox = document.getElementById('answerBox');
    const preview = document.getElementById('preview');
    const remoteAudio = document.getElementById('remoteAudio');

    const iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];
    let pc;
    let iceCandidates = [];

    const toUrlSafe = (str) => btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
    const fromUrlSafe = (str) => {
      const pad = '='.repeat((4 - str.length % 4) % 4);
      return atob(str.replace(/-/g, '+').replace(/_/g, '/') + pad);
    };

    function createPeer() {
      pc = new RTCPeerConnection({ iceServers });
      pc.onicecandidate = (e) => { if (e.candidate) iceCandidates.push(e.candidate.toJSON()); };
      pc.onicegatheringstatechange = () => {
        if (pc.iceGatheringState === 'complete') buildViewerLink();
      };
      pc.ontrack = (e) => {
        if (e.track.kind === 'audio') {
          remoteAudio.srcObject = e.streams[0];
        }
      };
    }

    async function startSharing() {
      createPeer();
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

      // Show preview of what you're sending
      preview.srcObject = screenStream;

      // Add screen tracks
      screenStream.getTracks().forEach(t => pc.addTrack(t, screenStream));
      // Add microphone track separately
      micStream.getAudioTracks().forEach(t => pc.addTrack(t, micStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      // Wait for ICE gathering to finish or timeout
      await waitForIceComplete(pc, 4000);
      buildViewerLink();
    }

    function buildViewerLink() {
      if (!pc || !pc.localDescription) return;
      const payload = {
        type: 'offer',
        sdp: pc.localDescription.sdp,
        candidates: iceCandidates
      };
      const encoded = toUrlSafe(JSON.stringify(payload));
      const baseUrl = location.href.replace('share.html', 'view.html');
      viewerLink.value = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}offer=${encoded}`;
    }

    async function waitForIceComplete(pc, timeoutMs) {
      if (pc.iceGatheringState === 'complete') return;
      await Promise.race([
        new Promise(res => pc.addEventListener('icegatheringstatechange', () => {
          if (pc.iceGatheringState === 'complete') res();
        })),
        new Promise(res => setTimeout(res, timeoutMs))
      ]);
    }

    async function applyAnswer() {
      if (!pc) return;
      const text = answerBox.value.trim();
      if (!text) return;
      try {
        const json = JSON.parse(fromUrlSafe(text));
        await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: json.sdp }));
        for (const c of json.candidates || []) {
          await pc.addIceCandidate(c);
        }
        alert('Connected.');
      } catch (err) {
        alert('Failed to apply answer: ' + err);
      }
    }

    startBtn.onclick = startSharing;
    copyLinkBtn.onclick = () => navigator.clipboard.writeText(viewerLink.value || '');
    applyAnswerBtn.onclick = applyAnswer;
  </script>
</body>
</html>