<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PeerSharing — Viewer (High-Visibility)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --zoom: 1; --ui-height: 120px; }
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family: system-ui, sans-serif; -webkit-font-smoothing:antialiased; }
    .stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    /* video should take as much space as possible */
    video#remote { max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain;
      transform: scale(var(--zoom));
      transition: transform .12s ease;
      background:#000;
      touch-action: none;
    }
    /* UI overlay */
    .overlay { position:fixed; left:0; right:0; bottom:0; height:var(--ui-height); background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85)); display:flex; gap:12px; align-items:center; padding:16px; box-sizing:border-box; }
    .overlay .left { flex:1; display:flex; flex-direction:column; gap:8px; }
    .status { font-size:18px; line-height:1.1; color:#ffd; }
    .copy-btn { background:#0078d4; color:#fff; border:none; padding:18px; font-size:20px; border-radius:8px; min-width:260px; cursor:pointer; }
    .copy-btn:disabled { background:#555; opacity:0.6; cursor:not-allowed; }
    .big-note { position:fixed; top:16px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.75); color:#fff; padding:12px 18px; border-radius:8px; font-size:20px; display:none; z-index:40; }
    .big-note.visible { display:block; }
    .controls { display:flex; gap:8px; align-items:center; }
    .zoom-slider { width:220px; }
    .zoom-label { font-size:16px; min-width:72px; text-align:center; }
    .hide-ui { background:transparent; border:1px solid #888; color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer; }
    /* fullscreen hint */
    .fs-hint { font-size:13px; color:#ccc; }
    /* when session active hide overlay (use .session-started on body) */
    body.session-started .overlay, body.session-started .big-note { display:none !important; }
    /* Large accessible copy indicator that persists until session start */
    .copied-banner { position:fixed; inset:auto 16px 16px 16px; background:#1b5e20; color:#fff; padding:14px 18px; border-radius:10px; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.6); z-index:45; display:none; }
    .copied-banner.visible { display:block; }
    /* ensure overlay never covers entire screen on very small devices */
    @media (max-height:420px) {
      :root { --ui-height:160px; }
      .overlay { flex-direction:column; align-items:stretch; height:var(--ui-height); }
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <video id="remote" autoplay playsinline></video>
  </div>

  <div class="big-note" id="bigNote" aria-live="polite"></div>

  <div class="copied-banner" id="copiedBanner" role="status" aria-live="assertive">Copied to clipboard — send this to the sharer. Waiting for session to start...</div>

  <div class="overlay" id="overlay">
    <div class="left">
      <div class="status" id="status">Waiting for offer in URL...</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <div class="controls" aria-hidden="false">
          <button class="hide-ui" id="fullscreenBtn" title="Toggle fullscreen">Fullscreen</button>
          <div style="width:8px;"></div>
          <div class="zoom-label">Zoom</div>
          <input id="zoom" class="zoom-slider" type="range" min="1" max="3" step="0.05" value="1" />
          <div class="zoom-label" id="zoomValue">100%</div>
        </div>
        <div style="flex:1"></div>
        <div class="fs-hint">Use pinch or slider to magnify. Click fullscreen for max size.</div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
      <button id="btnCopy" class="copy-btn" aria-live="polite" disabled>Preparing answer…</button>
      <button id="btnHide" class="hide-ui" title="Hide controls">Hide controls</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script>
    // Short, focused script implementing requested behavior.
    const params = new URLSearchParams(location.search);
    const compressedOffer = params.get('o');
    const statusEl = document.getElementById('status');
    const remote = document.getElementById('remote');
    const btnCopy = document.getElementById('btnCopy');
    const bigNote = document.getElementById('bigNote');
    const copiedBanner = document.getElementById('copiedBanner');
    const zoomInput = document.getElementById('zoom');
    const zoomValue = document.getElementById('zoomValue');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const overlay = document.getElementById('overlay');
    const btnHide = document.getElementById('btnHide');

    let pc;
    let compressedAnswer = '';
    let answerReady = false;
    let sessionStarted = false;

    function setStatus(t) { statusEl.textContent = t; bigNote.textContent = t; }

    function waitForIceComplete(pc, timeout = 10000) {
      return new Promise(resolve => {
        if (pc.iceGatheringState === 'complete') return resolve();
        const timer = setTimeout(() => { pc.onicecandidate = null; resolve(); }, timeout);
        pc.onicecandidate = (e) => {
          if (!e.candidate) { clearTimeout(timer); pc.onicecandidate = null; resolve(); }
        };
      });
    }

    async function buildAnswerFromOffer(comp) {
      try {
        setStatus('Parsing offer...');
        const json = LZString.decompressFromEncodedURIComponent(comp);
        if (!json) throw new Error('Failed to decompress offer.');
        const offer = JSON.parse(json);

        pc = new RTCPeerConnection();
        pc.ontrack = (evt) => {
          remote.srcObject = evt.streams[0];
        };

        setStatus('Setting remote description...');
        await pc.setRemoteDescription(offer);

        setStatus('Creating answer...');
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        setStatus('Waiting for ICE gathering to complete...');
        await waitForIceComplete(pc, 10000);

        const fullAnswer = pc.localDescription;
        const payload = JSON.stringify(fullAnswer);
        compressedAnswer = LZString.compressToEncodedURIComponent(payload);
        answerReady = true;
        btnCopy.disabled = false;
        btnCopy.textContent = 'Copy answer to clipboard';
        setStatus('Answer ready. Copy and send it to the sharer.');
      } catch (err) {
        console.error(err);
        setStatus('Error: ' + (err && err.message ? err.message : err));
        btnCopy.disabled = true;
        btnCopy.textContent = 'Error preparing answer';
      }
    }

    async function copyAnswer() {
      if (!answerReady || !compressedAnswer) return;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(compressedAnswer);
        } else {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = compressedAnswer;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        // show persistent, very visible indicator
        copiedBanner.classList.add('visible');
        bigNote.classList.add('visible');
        bigNote.textContent = 'Copied — send this to the sharer';
        // keep the copy button prominent (disable to avoid re-copy confusion)
        btnCopy.disabled = true;
        btnCopy.textContent = 'Copied — waiting for session';
      } catch (err) {
        console.error(err);
        setStatus('Copy failed: ' + (err && err.message ? err.message : err));
      }
    }

    // When session starts (remote video has content and plays) hide UI and indicators
    function onSessionStarted() {
      if (sessionStarted) return;
      sessionStarted = true;
      document.body.classList.add('session-started');
      copiedBanner.classList.remove('visible');
      bigNote.classList.remove('visible');
      // remove overlay from DOM focus for full viewing
      setStatus('Session started');
    }

    // zoom handling
    function updateZoom(v) {
      document.documentElement.style.setProperty('--zoom', v);
      zoomValue.textContent = Math.round(v * 100) + '%';
    }

    // fullscreen toggle
    async function toggleFullscreen() {
      try {
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      } catch (e) { /* ignore */ }
    }

    // initialize
    (async () => {
      // wire controls
      zoomInput.addEventListener('input', () => updateZoom(zoomInput.value));
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      btnCopy.addEventListener('click', copyAnswer);
      btnHide.addEventListener('click', () => { overlay.style.display = 'none'; });

      // keyboard zoom +/- for convenience
      window.addEventListener('keydown', (e) => {
        if (e.key === '+' || e.key === '=') zoomInput.value = Math.min(parseFloat(zoomInput.max), (parseFloat(zoomInput.value) + 0.1).toFixed(2));
        if (e.key === '-') zoomInput.value = Math.max(parseFloat(zoomInput.min), (parseFloat(zoomInput.value) - 0.1).toFixed(2));
        updateZoom(zoomInput.value);
      });

      // if no offer present
      if (!compressedOffer) { setStatus('No offer found in URL. Use the sender link.'); return; }

      setStatus('Offer found — preparing session and auto-creating answer...');
      await buildAnswerFromOffer(compressedOffer);

      // when remote video plays -> session started
      remote.addEventListener('playing', () => {
        onSessionStarted();
      });

      // Also detect tracks arriving from pc.ontrack earlier - some browsers may not fire playing immediately
      // but remote.srcObject will be set by ontrack. If tracks are already present and readyState indicates playing, start session.
      remote.addEventListener('loadedmetadata', () => {
        // attempt play to trigger 'playing'
        remote.play().catch(()=>{});
      });

      // initial zoom
      updateZoom(zoomInput.value);
    })();
  </script>
</body>
</html>