<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PeerSharing — Viewer (High-Visibility)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --zoom: 1; }
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family: system-ui, sans-serif; -webkit-font-smoothing:antialiased; }
    .stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .viewport { width:100%; height:100%; overflow:hidden; display:flex; align-items:center; justify-content:center; touch-action:none; }
    video#remote { width:100%; height:100%; object-fit:contain; transform-origin:center center; transform: translate(0px,0px) scale(var(--zoom)); transition: transform .06s linear; background:#000; will-change:transform; }

    .center-btn {
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:60;
      background:#0078d4; color:#fff; border:none; padding:28px 40px; font-size:28px; border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6); cursor:pointer; opacity:0.98; display:flex; align-items:center;
      justify-content:center; gap:14px; min-width:380px; text-align:center;
    }
    .center-btn:disabled { background:#444; cursor:not-allowed; opacity:0.9; }

    .copied-banner { position:fixed; left:16px; right:16px; bottom:16px; z-index:65; background:#1b5e20; color:#fff; padding:18px; font-size:20px; border-radius:10px; display:none; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    .copied-banner.visible { display:block; }

    .status { position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:62; background:rgba(0,0,0,0.6); color:#ffd; padding:8px 12px; border-radius:8px; font-size:18px; }

    /* manual copy modal */
    .modal { position:fixed; inset:0; z-index:200; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); padding:20px; box-sizing:border-box; }
    .modal.visible { display:flex; }
    .modal .box { width:100%; max-width:960px; background:#111; border-radius:12px; padding:16px; box-sizing:border-box; color:#fff; }
    .modal textarea { width:100%; height:240px; font-family:monospace; font-size:13px; padding:12px; box-sizing:border-box; background:#000; color:#0f0; border:1px solid #333; border-radius:8px; }
    .modal .row { display:flex; gap:10px; margin-top:12px; align-items:center; }
    .modal button { padding:12px 16px; font-size:16px; border-radius:8px; border:none; cursor:pointer; }
    .btn-primary { background:#0078d4; color:#fff; }
    .btn-secondary { background:#333; color:#fff; }

    body.session-started .center-btn,
    body.session-started .copied-banner,
    body.session-started .status { display:none !important; }

    @media (max-width:640px) {
      .center-btn { min-width:240px; padding:18px 22px; font-size:20px; border-radius:10px; }
      .status { font-size:16px; }
      .modal textarea { height:180px; font-size:12px; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="viewport" id="viewport">
      <video id="remote" autoplay playsinline></video>
    </div>
  </div>

  <div class="status" id="status" aria-live="polite">Waiting for offer in URL...</div>

  <button id="btnCopy" class="center-btn" disabled aria-live="polite">Preparing…</button>

  <div class="copied-banner" id="copiedBanner" role="status" aria-live="assertive">
    Copied to clipboard — send this to the sharer. Waiting for session to start...
  </div>

  <div class="modal" id="manualModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="box" role="document">
      <div style="font-size:18px;margin-bottom:8px;">Cannot copy automatically — please copy the answer manually and send it to the sharer</div>
      <textarea id="manualAnswer" readonly></textarea>
      <div class="row">
        <button id="selectCopy" class="btn-primary">Select & Copy</button>
        <button id="closeModal" class="btn-secondary">Close</button>
        <div style="flex:1"></div>
        <div style="color:#ddd;font-size:14px;">Tip: Ctrl+C after selection, then send via WhatsApp / messenger</div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const compressedOffer = params.get('o');
    const statusEl = document.getElementById('status');
    const remote = document.getElementById('remote');
    const viewport = document.getElementById('viewport');
    const btnCopy = document.getElementById('btnCopy');
    const copiedBanner = document.getElementById('copiedBanner');
    const manualModal = document.getElementById('manualModal');
    const manualAnswer = document.getElementById('manualAnswer');
    const selectCopy = document.getElementById('selectCopy');
    const closeModal = document.getElementById('closeModal');

    let pc;
    let compressedAnswer = '';
    let answerReady = false;
    let sessionStarted = false;
    let zoom = 1;
    let micStream = null;

    // pan state
    let panX = 0, panY = 0;
    let startPanX = 0, startPanY = 0;
    let pointerActive = false, pointerId = null;
    let startClientX = 0, startClientY = 0;
    let baseWidth = 0, baseHeight = 0;

    function setStatus(t) { statusEl.textContent = t; }

    function waitForIceComplete(pc, timeout = 10000) {
      return new Promise(resolve => {
        if (pc.iceGatheringState === 'complete') return resolve();
        const timer = setTimeout(() => { pc.onicecandidate = null; resolve(); }, timeout);
        pc.onicecandidate = (e) => {
          if (!e.candidate) { clearTimeout(timer); pc.onicecandidate = null; resolve(); }
        };
      });
    }

    async function prepareReceiver(comp) {
      try {
        setStatus('Parsing offer and preparing session (no mic yet)...');
        const json = LZString.decompressFromEncodedURIComponent(comp);
        if (!json) throw new Error('Failed to decompress offer.');
        const offer = JSON.parse(json);

        pc = new RTCPeerConnection();
        pc.ontrack = (evt) => {
          remote.srcObject = evt.streams[0];
        };

        await pc.setRemoteDescription(offer);
        setStatus('Ready. Click the button to share microphone and copy answer.');
        btnCopy.disabled = false;
        btnCopy.textContent = 'Share mic & Copy answer';
      } catch (err) {
        console.error(err);
        setStatus('Error preparing session: ' + (err && err.message ? err.message : err));
        btnCopy.disabled = true;
        btnCopy.textContent = 'No offer';
      }
    }

    function showManualCopyModal(text) {
      manualAnswer.value = text;
      manualModal.classList.add('visible');
      manualModal.setAttribute('aria-hidden', 'false');
      manualAnswer.focus();
      manualAnswer.select();
    }
    function hideManualCopyModal() {
      manualModal.classList.remove('visible');
      manualModal.setAttribute('aria-hidden', 'true');
    }

    function fallbackCopyToClipboard(text) {
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (e) { return false; }
    }

    async function onCopyClick() {
      btnCopy.disabled = true;
      btnCopy.textContent = 'Preparing answer…';
      setStatus('Requesting microphone permission...');

      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream.getAudioTracks().forEach(t => pc.addTrack(t, micStream));
        setStatus('Microphone added. Creating answer...');
      } catch (err) {
        console.warn('Microphone not available / denied:', err);
        setStatus('Microphone skipped. Creating answer without mic...');
      }

      try {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        setStatus('Gathering ICE candidates...');
        await waitForIceComplete(pc, 10000);

        const fullAnswer = pc.localDescription;
        const payload = JSON.stringify(fullAnswer);
        compressedAnswer = LZString.compressToEncodedURIComponent(payload);

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(compressedAnswer);
          } else {
            throw new Error('clipboard.writeText not available');
          }
          copiedBanner.classList.add('visible');
          btnCopy.textContent = 'Copied — waiting for session';
          setStatus('Answer copied. Send it to the sharer.');
          answerReady = true;
        } catch (copyErr) {
          console.warn('Clipboard API copy failed:', copyErr);
          const fallbackOk = fallbackCopyToClipboard(compressedAnswer);
          if (fallbackOk) {
            copiedBanner.classList.add('visible');
            btnCopy.textContent = 'Copied (fallback) — waiting for session';
            setStatus('Answer copied (fallback). Send it to the sharer.');
            answerReady = true;
          } else {
            showManualCopyModal(compressedAnswer);
            btnCopy.textContent = 'Copied (manual)';
            setStatus('Could not copy automatically. Please copy the text shown and send it to the sharer.');
            answerReady = true;
          }
        }
      } catch (err) {
        console.error(err);
        setStatus('Error creating answer: ' + (err && err.message ? err.message : err));
        btnCopy.textContent = 'Error';
      }
    }

    function onSessionStarted() {
      if (sessionStarted) return;
      sessionStarted = true;
      document.body.classList.add('session-started');
      setStatus('Session started');
      hideManualCopyModal();
    }

    // zoom / pan helpers
    function computeBaseSize() {
      const vw = viewport.clientWidth;
      const vh = viewport.clientHeight;
      const vW = remote.videoWidth || vw;
      const vH = remote.videoHeight || vh;
      const ratio = Math.min(vw / vW, vh / vH);
      baseWidth = Math.round(vW * ratio);
      baseHeight = Math.round(vH * ratio);
      clampPan();
      applyTransform();
    }

    function clampPan() {
      const vw = viewport.clientWidth;
      const vh = viewport.clientHeight;
      const scaledWidth = baseWidth * zoom;
      const scaledHeight = baseHeight * zoom;
      const maxPanX = Math.max(0, (scaledWidth - vw) / 2);
      const maxPanY = Math.max(0, (scaledHeight - vh) / 2);
      panX = Math.max(-maxPanX, Math.min(maxPanX, panX));
      panY = Math.max(-maxPanY, Math.min(maxPanY, panY));
    }

    function applyTransform() {
      remote.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
      document.documentElement.style.setProperty('--zoom', zoom);
    }

    function applyZoom(v, centerClientX = null, centerClientY = null) {
      const oldZoom = zoom;
      zoom = Math.max(1, Math.min(4, v));
      if (centerClientX !== null && centerClientY !== null) {
        const rect = viewport.getBoundingClientRect();
        const cx = centerClientX - rect.left - rect.width / 2;
        const cy = centerClientY - rect.top - rect.height / 2;
        panX = (panX - cx) * (zoom / oldZoom) + cx;
        panY = (panY - cy) * (zoom / oldZoom) + cy;
      } else {
        panX = panX * (zoom / oldZoom);
        panY = panY * (zoom / oldZoom);
      }
      clampPan();
      applyTransform();
    }

    function onPointerDown(e) {
      if (zoom <= 1) return;
      pointerActive = true;
      pointerId = e.pointerId;
      try { viewport.setPointerCapture(pointerId); } catch {}
      startClientX = e.clientX;
      startClientY = e.clientY;
      startPanX = panX;
      startPanY = panY;
    }

    function onPointerMove(e) {
      if (!pointerActive || e.pointerId !== pointerId) return;
      const dx = e.clientX - startClientX;
      const dy = e.clientY - startClientY;
      panX = startPanX + dx;
      panY = startPanY + dy;
      clampPan();
      applyTransform();
    }

    function onPointerUp(e) {
      if (!pointerActive || e.pointerId !== pointerId) return;
      pointerActive = false;
      try { viewport.releasePointerCapture(pointerId); } catch {}
      pointerId = null;
    }

    // event wiring
    btnCopy.addEventListener('click', onCopyClick);
    selectCopy.addEventListener('click', () => {
      manualAnswer.select();
      const ok = document.execCommand('copy');
      if (ok) {
        hideManualCopyModal();
        copiedBanner.classList.add('visible');
        btnCopy.textContent = 'Copied (manual) — waiting for session';
        setStatus('Copied to clipboard. Send it to the sharer.');
      } else {
        setStatus('Press Ctrl+C to copy, then close this dialog and send it.');
      }
    });
    closeModal.addEventListener('click', hideManualCopyModal);

    // zoom input handlers
    window.addEventListener('keydown', (e) => {
      if (e.key === '+' || e.key === '=') applyZoom(+(zoom + 0.2).toFixed(2));
      else if (e.key === '-') applyZoom(+(zoom - 0.2).toFixed(2));
    });

    viewport.addEventListener('dblclick', (ev) => {
      applyZoom(zoom < 2 ? 2.2 : 1, ev.clientX, ev.clientY);
    });

    window.addEventListener('wheel', (e) => {
      if (e.ctrlKey) return;
      if (Math.abs(e.deltaY) < 1) return;
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      applyZoom(+(zoom + delta).toFixed(2), e.clientX, e.clientY);
    }, { passive: true });

    viewport.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
    window.addEventListener('pointercancel', onPointerUp);
    window.addEventListener('resize', computeBaseSize);

    // session detection
    remote.addEventListener('loadedmetadata', () => {
      computeBaseSize();
      remote.play().catch(()=>{});
    });
    remote.addEventListener('playing', () => onSessionStarted());
    remote.addEventListener('resize', computeBaseSize);

    // start preparation
    if (!compressedOffer) {
      setStatus('No offer found in URL. Use the sender link.');
      btnCopy.disabled = true;
      btnCopy.textContent = 'No offer';
    } else {
      prepareReceiver(compressedOffer);
    }

    // initial zoom
    applyZoom(1);
  </script>
</body>
</html>