<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PeerSharing — Viewer (High-Visibility)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --zoom: 1; }
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family: system-ui, sans-serif; -webkit-font-smoothing:antialiased; }
    .stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .viewport { width:100%; height:100%; overflow:hidden; display:flex; align-items:center; justify-content:center; touch-action:none; }
    video#remote { width:100%; height:100%; object-fit:contain; transform-origin:center center; transform: translate(0px,0px) scale(var(--zoom)); transition: transform .06s linear; background:#000; will-change:transform; }
    .center-btn {
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:60;
      background:#0078d4; color:#fff; border:none; padding:28px 40px; font-size:30px; border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6); cursor:pointer; opacity:0.98; display:flex; align-items:center;
      justify-content:center; gap:14px; min-width:420px; text-align:center;
    }
    .center-btn:disabled { background:#444; cursor:not-allowed; opacity:0.9; }
    .copied-banner { position:fixed; left:16px; right:16px; bottom:16px; z-index:65; background:#1b5e20; color:#fff; padding:18px; font-size:20px; border-radius:10px; display:none; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    .copied-banner.visible { display:block; }
    .status { position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:62; background:rgba(0,0,0,0.6); color:#ffd; padding:8px 12px; border-radius:8px; font-size:18px; }
    body.session-started .center-btn, body.session-started .copied-banner, body.session-started .status { display:none !important; }
    @media (max-width:640px) { .center-btn { min-width:260px; padding:18px 22px; font-size:20px; border-radius:10px; } .status { font-size:16px; } }
  </style>
</head>
<body>
  <div class="stage">
    <div class="viewport" id="viewport">
      <video id="remote" autoplay playsinline></video>
    </div>
  </div>

  <div class="status" id="status" aria-live="polite">Waiting for offer in URL...</div>

  <button id="btnCopy" class="center-btn" disabled aria-live="polite">Preparing…</button>

  <div class="copied-banner" id="copiedBanner" role="status" aria-live="assertive">
    Copied to clipboard — send this to the sharer. Waiting for session to start...
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const compressedOffer = params.get('o');
    const statusEl = document.getElementById('status');
    const remote = document.getElementById('remote');
    const viewport = document.getElementById('viewport');
    const btnCopy = document.getElementById('btnCopy');
    const copiedBanner = document.getElementById('copiedBanner');

    let pc;
    let compressedAnswer = '';
    let answerReady = false;
    let sessionStarted = false;
    let zoom = 1;
    let micStream = null;

    function setStatus(t) { statusEl.textContent = t; }

    function waitForIceComplete(pc, timeout = 10000) {
      return new Promise(resolve => {
        if (pc.iceGatheringState === 'complete') return resolve();
        const timer = setTimeout(() => { pc.onicecandidate = null; resolve(); }, timeout);
        pc.onicecandidate = (e) => {
          if (!e.candidate) { clearTimeout(timer); pc.onicecandidate = null; resolve(); }
        };
      });
    }

    // Parse offer and set remote description only — do NOT create answer until user clicks button.
    async function prepareReceiver(comp) {
      try {
        setStatus('Parsing offer and preparing session (no mic yet)...');
        const json = LZString.decompressFromEncodedURIComponent(comp);
        if (!json) throw new Error('Failed to decompress offer.');
        const offer = JSON.parse(json);

        pc = new RTCPeerConnection();
        pc.ontrack = (evt) => {
          remote.srcObject = evt.streams[0];
        };

        await pc.setRemoteDescription(offer);
        setStatus('Ready. Click the button to share microphone and copy answer.');
        btnCopy.disabled = false;
        btnCopy.textContent = 'Share mic & Copy answer';
      } catch (err) {
        console.error(err);
        setStatus('Error preparing session: ' + (err && err.message ? err.message : err));
        btnCopy.disabled = true;
        btnCopy.textContent = 'No offer';
      }
    }

    // When the user clicks the main button: try to get mic, add tracks, create answer, wait ICE, compress & copy.
    async function onCopyClick() {
      btnCopy.disabled = true;
      btnCopy.textContent = 'Preparing answer…';
      setStatus('Requesting microphone permission...');

      let micAdded = false;
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream.getAudioTracks().forEach(t => pc.addTrack(t, micStream));
        micAdded = true;
        setStatus('Microphone added. Creating answer...');
      } catch (err) {
        console.warn('Microphone not available / denied:', err);
        // proceed without mic
        setStatus('Microphone skipped. Creating answer without mic...');
      }

      try {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        setStatus('Gathering ICE candidates...');
        await waitForIceComplete(pc, 10000);

        const fullAnswer = pc.localDescription;
        const payload = JSON.stringify(fullAnswer);
        compressedAnswer = LZString.compressToEncodedURIComponent(payload);

        // copy to clipboard
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(compressedAnswer);
          } else {
            const ta = document.createElement('textarea');
            ta.value = compressedAnswer;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          copiedBanner.classList.add('visible');
          btnCopy.textContent = 'Copied — waiting for session';
          setStatus('Answer copied. Send it to the sharer.');
        } catch (copyErr) {
          console.warn('Copy failed', copyErr);
          setStatus('Answer ready but copy failed — please paste manually.');
          btnCopy.textContent = 'Copy failed';
        }
      } catch (err) {
        console.error(err);
        setStatus('Error creating answer: ' + (err && err.message ? err.message : err));
        btnCopy.textContent = 'Error';
      }
    }

    function onSessionStarted() {
      if (sessionStarted) return;
      sessionStarted = true;
      document.body.classList.add('session-started');
      setStatus('Session started');
    }

    // zoom & pan basic handlers (kept minimal)
    function applyZoom(v, cx=null, cy=null) {
      zoom = Math.max(1, Math.min(4, v));
      document.documentElement.style.setProperty('--zoom', zoom);
      if (cx && cy) {
        // small visual focus behavior handled by CSS transform-origin center; complex pan retained earlier but omitted for brevity
      }
    }
    window.addEventListener('wheel', (e) => {
      if (e.ctrlKey) return;
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      applyZoom(+(zoom + delta).toFixed(2));
    }, { passive:true });
    viewport.addEventListener('dblclick', () => applyZoom( zoom < 2 ? 2.2 : 1 ));

    // wire events
    btnCopy.addEventListener('click', onCopyClick);
    remote.addEventListener('playing', () => onSessionStarted());
    remote.addEventListener('loadedmetadata', () => { remote.play().catch(()=>{}); });

    // start
    if (!compressedOffer) {
      setStatus('No offer found in URL. Use the sender link.');
      btnCopy.disabled = true;
      btnCopy.textContent = 'No offer';
    } else {
      prepareReceiver(compressedOffer);
    }
  </script>
</body>
</html>