<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Screen Share</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #remoteVideo {
            width: 100%;
            height: 100vh;
            object-fit: contain;
            background: #000;
            touch-action: pinch-zoom;
        }
        #controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            z-index: 1000;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #shareLink {
            background: #2196F3;
        }
        #status {
            margin: 10px 0;
            font-size: 16px;
        }
        .link-box {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
        }
        #hideControls {
            background: #ff9800;
            font-size: 14px;
            padding: 10px 20px;
        }
        .hidden {
            display: none;
        }
        #audioIndicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.8);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <h2>P2P Screen Share & Audio</h2>
            <div id="status">Ready to connect</div>
            <div id="sharerControls" class="hidden">
                <button id="startShare">Start Sharing</button>
                <div id="linkContainer" class="hidden">
                    <div class="link-box" id="linkDisplay"></div>
                    <button id="copyLink">Copy Link</button>
                </div>
            </div>
            <div id="viewerControls" class="hidden">
                <p>Connecting to screen share...</p>
            </div>
            <button id="hideControls" class="hidden">Hide Controls (Press H to show)</button>
        </div>
        <video id="remoteVideo" autoplay playsinline class="hidden"></video>
        <div id="audioIndicator">ðŸŽ¤ Speaking</div>
    </div>

    <script>
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        let pc = null;
        let dataChannel = null;
        let isSharer = false;
        let localStream = null;

        const statusEl = document.getElementById('status');
        const startShareBtn = document.getElementById('startShare');
        const linkContainer = document.getElementById('linkContainer');
        const linkDisplay = document.getElementById('linkDisplay');
        const copyLinkBtn = document.getElementById('copyLink');
        const remoteVideo = document.getElementById('remoteVideo');
        const sharerControls = document.getElementById('sharerControls');
        const viewerControls = document.getElementById('viewerControls');
        const controlsDiv = document.getElementById('controls');
        const hideControlsBtn = document.getElementById('hideControls');
        const audioIndicator = document.getElementById('audioIndicator');

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const offerData = urlParams.get('offer');

        if (offerData) {
            // Viewer mode
            isSharer = false;
            viewerControls.classList.remove('hidden');
            initViewer(offerData);
        } else {
            // Sharer mode
            isSharer = true;
            sharerControls.classList.remove('hidden');
        }

        startShareBtn.addEventListener('click', async () => {
            try {
                // Get screen share
                const screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: false
                });

                // Get microphone
                const audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false
                });

                localStream = new MediaStream([
                    ...screenStream.getTracks(),
                    ...audioStream.getTracks()
                ]);

                await createOffer();
                startShareBtn.disabled = true;
                statusEl.textContent = 'Share this link with your friend:';
            } catch (err) {
                statusEl.textContent = 'Error: ' + err.message;
            }
        });

        async function createOffer() {
            pc = new RTCPeerConnection(config);

            // Add tracks to connection
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // Create data channel for signaling
            dataChannel = pc.createDataChannel('signal');
            setupDataChannel();

            pc.onicecandidate = (event) => {
                if (event.candidate === null) {
                    // All ICE candidates gathered
                    const offer = btoa(JSON.stringify(pc.localDescription));
                    const viewerUrl = `${window.location.origin}${window.location.pathname}?offer=${offer}`;
                    linkDisplay.textContent = viewerUrl;
                    linkContainer.classList.remove('hidden');
                    hideControlsBtn.classList.remove('hidden');
                }
            };

            pc.ondatachannel = (event) => {
                const channel = event.channel;
                channel.onmessage = async (e) => {
                    const answer = JSON.parse(atob(e.data));
                    await pc.setRemoteDescription(answer);
                    statusEl.textContent = 'Connected! Sharing screen and audio.';
                };
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
        }

        async function initViewer(offerData) {
            pc = new RTCPeerConnection(config);

            pc.ontrack = (event) => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.classList.remove('hidden');
                    controlsDiv.classList.add('hidden');
                    statusEl.textContent = 'Connected!';
                    
                    // Audio level detection
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(event.streams[0]);
                    const analyzer = audioContext.createAnalyser();
                    source.connect(analyzer);
                    
                    const dataArray = new Uint8Array(analyzer.frequencyBinCount);
                    function checkAudio() {
                        analyzer.getByteFrequencyData(dataArray);
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        if (average > 10) {
                            audioIndicator.style.display = 'block';
                            setTimeout(() => {
                                audioIndicator.style.display = 'none';
                            }, 200);
                        }
                        requestAnimationFrame(checkAudio);
                    }
                    checkAudio();
                }
            };

            pc.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel();
            };

            const offer = JSON.parse(atob(offerData));
            await pc.setRemoteDescription(offer);

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            pc.onicecandidate = (event) => {
                if (event.candidate === null && dataChannel && dataChannel.readyState === 'open') {
                    const answerData = btoa(JSON.stringify(pc.localDescription));
                    dataChannel.send(answerData);
                }
            };
        }

        function setupDataChannel() {
            if (!dataChannel) return;
            
            dataChannel.onopen = () => {
                console.log('Data channel opened');
            };
            
            dataChannel.onclose = () => {
                statusEl.textContent = 'Connection closed';
            };
        }

        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(linkDisplay.textContent);
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyLinkBtn.textContent = 'Copy Link';
            }, 2000);
        });

        hideControlsBtn.addEventListener('click', () => {
            controlsDiv.classList.add('hidden');
        });

        // Press H to show controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'h' || e.key === 'H') {
                controlsDiv.classList.toggle('hidden');
            }
        });

        // Handle page close
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (pc) {
                pc.close();
            }
        });
    </script>
</body>
</html>