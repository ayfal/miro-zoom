<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PeerSharing — Sender</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 900px; }
    textarea { width: 100%; height: 120px; font-family: monospace; }
    input[type=text] { width: 100%; }
    video { width: 48%; max-height: 360px; background: #000; }
    .row { display:flex; gap:8px; align-items:flex-start; margin-top:8px; }
    .col { flex:1; }
  </style>
</head>
<body>
  <h1>PeerSharing — Sender</h1>

  <p>This page will capture your microphone + screen, create an SDP offer and produce a compressed viewer link. Paste the viewer's compressed answer below and click "Set Answer".</p>

  <button id="btnOffer">Generate Offer & Viewer Link</button>
  <div id="status"></div>

  <h3>Viewer link (share this)</h3>
  <input type="text" id="viewerLink" readonly />

  <h3>Local / Remote preview</h3>
  <div class="row">
    <div class="col">
      <p>Local (screen)</p>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div class="col">
      <p>Remote (what viewer receives)</p>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <h3>Paste compressed answer from viewer</h3>
  <textarea id="answerArea" placeholder="Paste compressed answer here (viewer->copy)"></textarea>
  <button id="btnSetAnswer">Set Answer & Start</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script>
    // Minimal helper: wait for ICE gathering to finish (onicecandidate null indicates done)
    function waitForIceComplete(pc, timeout = 10000) {
      return new Promise((resolve, reject) => {
        if (pc.iceGatheringState === 'complete') return resolve();
        const timer = setTimeout(() => {
          pc.onicecandidate = null;
          resolve(); // timeout: proceed anyway
        }, timeout);
        pc.onicecandidate = (e) => {
          if (!e.candidate) {
            clearTimeout(timer);
            pc.onicecandidate = null;
            resolve();
          }
        };
      });
    }

    let pc;
    let localStream;
    const btnOffer = document.getElementById('btnOffer');
    const viewerLink = document.getElementById('viewerLink');
    const status = document.getElementById('status');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const answerArea = document.getElementById('answerArea');
    const btnSetAnswer = document.getElementById('btnSetAnswer');

    btnOffer.onclick = async () => {
      try {
        status.textContent = 'Creating peer connection and gathering local media...';
        pc = new RTCPeerConnection();

        // Show remote tracks when they arrive (viewer side would show what sender sends)
        pc.ontrack = (evt) => {
          remoteVideo.srcObject = evt.streams[0];
        };

        // Get microphone + screen
        const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });

        // Combine streams: add audio tracks and screen tracks to PC, show local preview as combined stream
        localStream = new MediaStream();
        audioStream.getAudioTracks().forEach(t => { pc.addTrack(t, audioStream); localStream.addTrack(t); });
        screenStream.getVideoTracks().forEach(t => { pc.addTrack(t, screenStream); localStream.addTrack(t); });

        localVideo.srcObject = localStream;

        // Create offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        status.textContent = 'Waiting for ICE gathering to complete...';
        await waitForIceComplete(pc, 10000);

        // Use the finalized localDescription
        const fullOffer = pc.localDescription;
        const payload = JSON.stringify(fullOffer);
        const compressed = LZString.compressToEncodedURIComponent(payload);

        // Build viewer URL (viewer.html in same folder)
        const url = window.location.origin + window.location.pathname.replace(/index\.html?$/,'viewer.html') + '?o=' + compressed;
        viewerLink.value = url;
        status.textContent = 'Offer ready. Share the viewer link.';
      } catch (err) {
        console.error(err);
        status.textContent = 'Error: ' + err;
      }
    };

    btnSetAnswer.onclick = async () => {
      if (!pc) {
        status.textContent = 'No peer connection. Generate an offer first.';
        return;
      }
      const compressed = answerArea.value.trim();
      if (!compressed) { status.textContent = 'Paste compressed answer first.'; return; }
      try {
        status.textContent = 'Decoding answer and setting remote description...';
        const json = LZString.decompressFromEncodedURIComponent(compressed);
        if (!json) throw new Error('Failed to decompress answer.');
        const answer = JSON.parse(json);
        await pc.setRemoteDescription(answer);
        status.textContent = 'Remote description set. Connection should establish when tracks arrive.';
      } catch (err) {
        console.error(err);
        status.textContent = 'Error: ' + err;
      }
    };
  </script>
</body>
</html>